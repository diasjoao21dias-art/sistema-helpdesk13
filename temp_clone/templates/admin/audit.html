{% extends "admin/dashboard.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Admin Sidebar -->
    <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Menu Administrativo</span>
        </h6>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/admin">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/users">
              <i class="bi bi-people"></i> Usuários
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/sectors">
              <i class="bi bi-building"></i> Setores
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/roles">
              <i class="bi bi-shield-check"></i> Papéis & Permissões
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/relatorios">
              <i class="bi bi-bar-chart"></i> Relatórios
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/settings">
              <i class="bi bi-gear"></i> Configurações
            </a>
          </li>
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Monitoramento</span>
        </h6>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/admin/monitoring">
              <i class="bi bi-activity"></i> Status do Sistema
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/logs">
              <i class="bi bi-journal-text"></i> Logs de Atividades
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/maintenance">
              <i class="bi bi-tools"></i> Manutenção
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/admin/audit">
              <i class="bi bi-shield-lock"></i> Auditoria
            </a>
          </li>
        </ul>
        
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Sistema</span>
        </h6>
        <ul class="nav flex-column mb-2">
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="bi bi-house"></i> Voltar ao Sistema
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
          <i class="bi bi-shield-lock text-primary"></i> Auditoria e Segurança
        </h1>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Security Overview -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-success text-white shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-white-50 small">Logins (24h)</div>
                  <div class="h5 mb-0 font-weight-bold">{{ security_stats.logins_24h or 0 }}</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-box-arrow-in-right fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-warning text-white shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-white-50 small">Ações Admin (24h)</div>
                  <div class="h5 mb-0 font-weight-bold">{{ security_stats.admin_actions or 0 }}</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-gear fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-info text-white shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-white-50 small">Usuários Ativos</div>
                  <div class="h5 mb-0 font-weight-bold">{{ security_stats.active_users or 0 }}</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-people fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card bg-secondary text-white shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-white-50 small">IPs Únicos</div>
                  <div class="h5 mb-0 font-weight-bold">{{ security_stats.unique_ips or 0 }}</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-router fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Details -->
      <div class="row mb-4">
        <div class="col-lg-6">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-activity"></i> Atividades por Tipo (24h)
              </h6>
            </div>
            <div class="card-body">
              {% if security_stats.actions_by_type %}
                <div class="table-responsive">
                  <table class="table table-borderless">
                    {% for action_type, count in security_stats.actions_by_type.items() %}
                    <tr>
                      <td>
                        <span class="badge bg-secondary">{{ action_type }}</span>
                      </td>
                      <td class="text-end">
                        <strong>{{ count }}</strong>
                      </td>
                      <td width="40%">
                        <div class="progress" style="height: 10px;">
                          {% set max_count = security_stats.actions_by_type.values() | list | max %}
                          {% set percentage = (count / max_count * 100) if max_count > 0 else 0 %}
                          <div class="progress-bar bg-info" role="progressbar" 
                               style="width: {{ percentage }}%" 
                               aria-valuenow="{{ count }}" aria-valuemin="0" aria-valuemax="{{ max_count }}">
                          </div>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </table>
                </div>
              {% else %}
                <p class="text-muted">Nenhuma atividade registrada nas últimas 24 horas</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-people-fill"></i> Estatísticas de Usuários
              </h6>
            </div>
            <div class="card-body">
              {% if user_stats.error %}
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i> Erro ao obter estatísticas: {{ user_stats.error }}
                </div>
              {% else %}
                <div class="row text-center">
                  <div class="col-4">
                    <div class="border-end">
                      <div class="h4 font-weight-bold text-primary">{{ user_stats.total_users or 0 }}</div>
                      <div class="small text-gray-500">Total</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="border-end">
                      <div class="h4 font-weight-bold text-warning">{{ user_stats.admin_users or 0 }}</div>
                      <div class="small text-gray-500">Admins</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="h4 font-weight-bold text-success">{{ user_stats.active_users or 0 }}</div>
                    <div class="small text-gray-500">Ativos</div>
                  </div>
                </div>

                <hr>

                <div class="small text-muted">
                  <p><strong>Distribuição por Função:</strong></p>
                  {% if user_stats.total_users and user_stats.total_users > 0 %}
                    {% set admin_percent = (user_stats.admin_users / user_stats.total_users * 100) %}
                    {% set regular_percent = 100 - admin_percent %}
                    <div class="progress mb-2" style="height: 20px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ admin_percent }}%" 
                           aria-valuenow="{{ admin_percent }}" aria-valuemin="0" aria-valuemax="100">
                        Admins ({{ "%.1f"|format(admin_percent) }}%)
                      </div>
                      <div class="progress-bar bg-info" role="progressbar" 
                           style="width: {{ regular_percent }}%" 
                           aria-valuenow="{{ regular_percent }}" aria-valuemin="0" aria-valuemax="100">
                        Usuários ({{ "%.1f"|format(regular_percent) }}%)
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Security Recommendations -->
      <div class="row">
        <div class="col-lg-12">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-shield-check"></i> Recomendações de Segurança
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6><i class="bi bi-check-circle text-success"></i> Medidas Implementadas</h6>
                  <ul class="list-unstyled">
                    <li><i class="bi bi-check text-success"></i> Autenticação baseada em sessão</li>
                    <li><i class="bi bi-check text-success"></i> Controle de acesso por papéis</li>
                    <li><i class="bi bi-check text-success"></i> Log completo de atividades</li>
                    <li><i class="bi bi-check text-success"></i> Backup automático do banco</li>
                    <li><i class="bi bi-check text-success"></i> Validação de entrada de dados</li>
                    <li><i class="bi bi-check text-success"></i> Hash seguro de senhas</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6><i class="bi bi-exclamation-triangle text-warning"></i> Recomendações</h6>
                  <ul class="list-unstyled">
                    <li><i class="bi bi-arrow-right text-warning"></i> Revisar logs regularmente</li>
                    <li><i class="bi bi-arrow-right text-warning"></i> Manter backups atualizados</li>
                    <li><i class="bi bi-arrow-right text-warning"></i> Monitorar atividades suspeitas</li>
                    <li><i class="bi bi-arrow-right text-warning"></i> Limpar logs antigos periodicamente</li>
                    <li><i class="bi bi-arrow-right text-warning"></i> Verificar permissões de usuários</li>
                    <li><i class="bi bi-arrow-right text-warning"></i> Testar procedimentos de restauração</li>
                  </ul>
                </div>
              </div>

              <hr>

              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Observação:</strong> Este painel mostra atividades das últimas 24 horas. 
                Para análises mais profundas, consulte os logs detalhados na seção "Logs de Atividades".
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
{% endblock %}