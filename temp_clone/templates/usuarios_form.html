{% extends "base.html" %}
{% block content %}
  <h3>{{ 'Editar' if u else 'Novo' }} Usuário</h3>
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="POST">
        <div class="mb-3">
          <label class="form-label">Usuário</label>
          <input class="form-control" name="username" value="{{ u.username if u else '' }}" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Senha {% if u %}(deixe em branco para manter){% endif %}</label>
          <input class="form-control" type="password" name="password" {% if not u %}required{% endif %}>
        </div>
        <div class="mb-3">
          <label class="form-label">Perfil</label>
          <select name="role" class="form-select">
            {% for r in ['admin','operador','usuario'] %}
              <option value="{{ r }}" {% if u and u.role==r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        
        <div class="mb-3">
          <label class="form-label">Setor (para operadores)</label>
          <select name="setor" class="form-select">
            <option value="">-- selecione --</option>
            {% if sectors %}
              {% for s in sectors %}
                <option value="{{ s.name if s.name else s.display_name }}" 
                  {% if u and u.setor == (s.name if s.name else s.display_name) %}selected{% endif %}>{{ s.display_name }}</option>
              {% endfor %}
            {% else %}
              <!-- Fallback para setores antigos -->
              {% for s in ['T.I','Manutenção','CCIH / SESMT / Manutenção de Ar condicionado','Telefonia e outros serviços'] %}
                <option value="{{ s }}" {% if u and u.setor==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            {% endif %}
          </select>
          <div class="form-text">Obrigatório quando perfil = operador.</div>
        </div>
        <button class="btn btn-primary">Salvar</button>
        <a class="btn btn-secondary" href="{{ url_for('usuarios_list') }}">Cancelar</a>
      </form>
    </div>
  </div>
{% endblock %}