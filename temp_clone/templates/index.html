{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1"><i class="bi bi-ticket-perforated me-2"></i>Gerenciamento de Chamados</h2>
      <p class="text-muted mb-0">Visualize e gerencie todos os chamados do sistema</p>
    </div>
    {% if user.has_permission('create_tickets') %}
    <a class="btn btn-primary btn-lg d-none d-md-inline-block" href="{{ url_for('chamados_novo') }}">
      <i class="bi bi-plus-circle me-2"></i>Novo Chamado
    </a>
    {% endif %}
  </div>
  {% if chamados %}
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Lista de Chamados</h5>
      <a href="?sort={{ next_sort }}" class="btn btn-outline-secondary btn-sm" title="Alternar ordenação">
        <i class="{{ sort_icon }} me-1"></i>{{ sort_label }}
      </a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0 table-mobile-compact d-none d-md-table">
          <thead>
            <tr>
              <th class="px-4">#</th>
              <th>Título</th>
              <th>Status</th>
              <th>Urgência</th>
              <th>Setor</th>
              <th>Abertura</th>
              <th>Fechamento</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for c in chamados %}
              <tr data-ticket-id="{{ c.id }}">
                <td class="px-4"><strong>#{{ c.id }}</strong></td>
                <td><strong>{{ c.titulo }}</strong></td>
                <td>
                  <span class="badge {% if c.status=='Fechado' %}bg-success{% elif c.status=='Em Andamento' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ c.status }}</span>
                </td>
                <td>
                  {% if c.urgencia %}
                    {% if c.urgencia == 'Urgente' %}
                      <span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> {{ c.urgencia }}</span>
                    {% else %}
                      <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> {{ c.urgencia }}</span>
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ c.setor or '—' }}</td>
                <td>{{ c.criado_em.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{% if c.fechado_em %}{{ c.fechado_em.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}</td>
                <td class="text-center text-nowrap">
                  <a class="btn btn-sm btn-outline-info" href="{{ url_for('chamados_view', cid=c.id) }}">
                    <i class="bi bi-eye"></i> Ver
                  </a>
                  {% if user.has_permission('edit_tickets') %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('chamados_editar', cid=c.id) }}">
                      <i class="bi bi-pencil"></i> Editar
                    </a>
                  {% endif %}
                  {% if user.has_permission('delete_tickets') %}
                    <a class="btn btn-sm btn-outline-danger" href="{{ url_for('chamados_excluir', cid=c.id) }}" onclick="return confirm('Excluir chamado {{ c.id }}?')">
                      <i class="bi bi-trash"></i> Excluir
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Mobile Card View -->
      <div class="d-md-none">
        <!-- Mobile Sort Button -->
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
          <small class="text-muted">{{ chamados|length }} chamado(s)</small>
          <a href="?sort={{ next_sort }}" class="btn btn-outline-secondary btn-sm">
            <i class="{{ sort_icon }} me-1"></i>{{ sort_label }}
          </a>
        </div>
        {% for c in chamados %}
        <div class="ticket-card">
          <div class="ticket-header">
            <div>
              <strong>#{{ c.id }}</strong> - 
              <span class="badge {% if c.status=='Fechado' %}bg-success{% elif c.status=='Em Andamento' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ c.status }}</span>
            </div>
            {% if c.urgencia %}
            <span class="badge {% if c.urgencia == 'Urgente' %}bg-danger{% else %}bg-success{% endif %}">
              <i class="bi bi-{% if c.urgencia == 'Urgente' %}exclamation-triangle-fill{% else %}check-circle-fill{% endif %}"></i> {{ c.urgencia }}
            </span>
            {% endif %}
          </div>
          <h6 class="ticket-title">{{ c.titulo }}</h6>
          <div class="ticket-meta">
            <i class="bi bi-building me-1"></i>{{ c.setor or '—' }} • 
            <i class="bi bi-calendar me-1"></i>{{ c.criado_em.strftime('%d/%m/%Y %H:%M') }}
            {% if c.fechado_em %} • <i class="bi bi-check-circle me-1"></i>{{ c.fechado_em.strftime('%d/%m/%Y %H:%M') }}{% endif %}
          </div>
          <div class="d-flex gap-2 mt-3">
            <a class="btn btn-sm btn-outline-info flex-fill" href="{{ url_for('chamados_view', cid=c.id) }}">
              <i class="bi bi-eye"></i> Ver
            </a>
            {% if user.has_permission('edit_tickets') %}
            <a class="btn btn-sm btn-outline-primary flex-fill" href="{{ url_for('chamados_editar', cid=c.id) }}">
              <i class="bi bi-pencil"></i> Editar
            </a>
            {% endif %}
            {% if user.has_permission('delete_tickets') %}
            <a class="btn btn-sm btn-outline-danger flex-fill" href="{{ url_for('chamados_excluir', cid=c.id) }}" onclick="return confirm('Excluir chamado {{ c.id }}?')">
              <i class="bi bi-trash"></i>
            </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center py-5">
    <div class="card">
      <div class="card-body py-5">
        <i class="bi bi-ticket-perforated text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">Nenhum chamado encontrado</h4>
        <p class="text-muted mb-4">
          {% if user.has_permission('create_tickets') %}
            Não há chamados no sistema no momento. Clique no botão abaixo para criar o primeiro chamado.
          {% else %}
            Não há chamados visíveis para você no momento.
          {% endif %}
        </p>
        {% if user.has_permission('create_tickets') %}
        <a class="btn btn-primary btn-lg" href="{{ url_for('chamados_novo') }}">
          <i class="bi bi-plus-circle me-2"></i>Criar Primeiro Chamado
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Mobile Floating Action Button -->
  {% if user.has_permission('create_tickets') %}
  <div class="d-md-none thumb-nav">
    <a class="btn btn-primary" href="{{ url_for('chamados_novo') }}" title="Novo Chamado">
      <i class="bi bi-plus-lg"></i>
    </a>
  </div>
  {% endif %}
{% endblock %}