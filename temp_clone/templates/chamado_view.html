{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Visualizar Chamado #{{ chamado.id }}</h3>
      <div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
        {% if user.has_permission('close_tickets') and chamado.status != 'Fechado' %}
          <a href="{{ url_for('chamados_fechar', cid=chamado.id) }}" class="btn btn-success ms-2">
            <i class="bi bi-check-circle"></i> Fechar Chamado
          </a>
        {% endif %}
        {% if user.has_permission('edit_tickets') %}
          <a href="{{ url_for('chamados_editar', cid=chamado.id) }}" class="btn btn-primary ms-2">
            <i class="bi bi-pencil"></i> Editar
          </a>
        {% endif %}
        {% if user.has_permission('delete_tickets') %}
          <a href="{{ url_for('chamados_excluir', cid=chamado.id) }}" 
             class="btn btn-danger ms-2" 
             onclick="return confirm('Tem certeza que deseja excluir este chamado?')">
            <i class="bi bi-trash"></i> Excluir
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">Detalhes do Chamado</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label text-muted">Título:</label>
            <p class="fw-bold">{{ chamado.titulo }}</p>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted">Status:</label>
            <p>
              {% if chamado.status == 'Aberto' %}
                <span class="badge bg-danger">{{ chamado.status }}</span>
              {% elif chamado.status == 'Em Andamento' %}
                <span class="badge bg-warning">{{ chamado.status }}</span>
              {% elif chamado.status == 'Fechado' %}
                <span class="badge bg-success">{{ chamado.status }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ chamado.status }}</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted">Setor:</label>
            <p>{{ chamado.setor or '—' }}</p>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-muted">Descrição:</label>
          <div class="p-3 bg-light rounded">
            <p style="white-space: pre-wrap; margin: 0;">{{ chamado.descricao }}</p>
          </div>
        </div>
        
        {% if chamado.get_images() %}
        <div class="mb-3">
          <label class="form-label text-muted">Imagens Anexadas:</label>
          <div class="row g-2">
            {% for image in chamado.get_images() %}
            <div class="col-md-4">
              <div class="card">
                <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                     class="card-img-top" 
                     style="height: 200px; object-fit: contain;"
                     alt="Imagem anexada">
                <div class="card-body p-2 text-center">
                  <small class="text-muted">Imagem {{ loop.index }}</small>
                  <br>
                  <a href="{{ url_for('static', filename='uploads/' + image) }}" 
                     target="_blank" 
                     class="btn btn-sm btn-outline-primary mt-1">
                    <i class="bi bi-eye"></i> Ver em tamanho real
                  </a>
                  <button type="button" 
                          class="btn btn-sm btn-outline-success mt-1 ms-1 print-image-btn" 
                          data-image-url="{{ url_for('static', filename='uploads/' + image) }}"
                          data-image-title="Imagem {{ loop.index }} - Chamado #{{ chamado.id }}">
                    <i class="bi bi-printer"></i> Imprimir
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Modal for full-size image -->
            <div class="modal fade" id="imageModal{{ loop.index }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Imagem {{ loop.index }} - Chamado #{{ chamado.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body text-center">
                    <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                         class="img-fluid" 
                         alt="Imagem anexada">
                  </div>
                  <div class="modal-footer">
                    <button type="button" 
                            class="btn btn-success print-modal-btn" 
                            data-image-url="{{ url_for('static', filename='uploads/' + image) }}"
                            data-image-title="Imagem {{ loop.index }} - Chamado #{{ chamado.id }}">
                      <i class="bi bi-printer"></i> Imprimir Esta Imagem
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- JavaScript para funcionalidade de impressão de imagens -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Função para imprimir imagem sem causar conflitos
            function printImage(imageUrl, imageTitle) {
                // Prevenir múltiplas execuções
                if (window.isPrinting) {
                    return;
                }
                
                window.isPrinting = true;
                
                try {
                    // Criar uma nova janela para impressão
                    const printWindow = window.open('', '_blank', 'width=800,height=600');
                    
                    if (printWindow) {
                        printWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <title>${imageTitle}</title>
                                <style>
                                    body {
                                        margin: 0;
                                        padding: 20px;
                                        display: flex;
                                        justify-content: center;
                                        align-items: center;
                                        min-height: 100vh;
                                        font-family: Arial, sans-serif;
                                    }
                                    .container {
                                        text-align: center;
                                        max-width: 100%;
                                    }
                                    h1 {
                                        font-size: 18px;
                                        margin-bottom: 20px;
                                        color: #333;
                                    }
                                    img {
                                        max-width: 100%;
                                        max-height: 80vh;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                    }
                                    @media print {
                                        body { margin: 0; padding: 0; }
                                        .container { page-break-inside: avoid; }
                                        img { max-height: 100vh; }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h1>${imageTitle}</h1>
                                    <img src="${imageUrl}" alt="${imageTitle}" onload="window.print(); window.close();" onerror="alert('Erro ao carregar imagem'); window.close();">
                                </div>
                            </body>
                            </html>
                        `);
                        printWindow.document.close();
                    } else {
                        alert('Por favor, permita pop-ups para imprimir a imagem.');
                    }
                } catch (error) {
                    console.error('Erro na impressão:', error);
                    alert('Erro ao tentar imprimir a imagem.');
                } finally {
                    // Resetar flag após um tempo
                    setTimeout(() => {
                        window.isPrinting = false;
                    }, 2000);
                }
            }
            
            // Event listeners para os botões de impressão
            document.querySelectorAll('.print-image-btn, .print-modal-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const imageUrl = this.getAttribute('data-image-url');
                    const imageTitle = this.getAttribute('data-image-title');
                    
                    if (imageUrl && imageTitle) {
                        printImage(imageUrl, imageTitle);
                    }
                });
            });
        });
        </script>
        {% endif %}
        
        {% if chamado.resolucao and chamado.status == 'Fechado' %}
        <div class="mb-3">
          <label class="form-label text-muted">Resolução:</label>
          <div class="p-3 bg-success bg-opacity-10 border border-success rounded">
            <p style="white-space: pre-wrap; margin: 0;">{{ chamado.resolucao }}</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="card-title mb-0">Informações do Chamado</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label text-muted small">Número do Chamado:</label>
          <p class="fw-bold">#{{ chamado.id }}</p>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-muted small">Criado em:</label>
          <p>{{ chamado.criado_em.strftime('%d/%m/%Y às %H:%M') }}</p>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-muted small">Aberto por:</label>
          <p>{{ chamado.usuario.username if chamado.usuario else 'N/A' }}</p>
        </div>
        
        {% if chamado.usuario_setor %}
        <div class="mb-3">
          <label class="form-label text-muted small">Setor do Solicitante:</label>
          <p><span class="badge bg-info">{{ chamado.usuario_setor }}</span></p>
        </div>
        {% endif %}
        
        {% if chamado.ramal %}
        <div class="mb-3">
          <label class="form-label text-muted small">Ramal:</label>
          <p><span class="badge bg-primary">{{ chamado.ramal }}</span></p>
        </div>
        {% endif %}
        
        {% if chamado.cdc %}
        <div class="mb-3">
          <label class="form-label text-muted small">Informe CDC:</label>
          <p><span class="badge bg-warning text-dark">{{ chamado.cdc }}</span></p>
        </div>
        {% endif %}
        
        {% if chamado.fechado_em %}
        <div class="mb-3">
          <label class="form-label text-muted small">Fechado em:</label>
          <p>{{ chamado.fechado_em.strftime('%d/%m/%Y às %H:%M') }}</p>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-muted small">Fechado por:</label>
          <p>{{ chamado.fechado_por.username if chamado.fechado_por else 'N/A' }}</p>
        </div>
        
        {% if chamado.urgencia %}
        <div class="mb-3">
          <label class="form-label text-muted small">Classificação de Urgência:</label>
          <p>
            {% if chamado.urgencia == 'Urgente' %}
              <span class="badge bg-danger"><i class="bi bi-exclamation-triangle-fill"></i> {{ chamado.urgencia }}</span>
            {% else %}
              <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> {{ chamado.urgencia }}</span>
            {% endif %}
          </p>
        </div>
        {% endif %}
        
        <div class="mb-3">
          <label class="form-label text-muted small">Tempo de resolução:</label>
          <p class="text-success fw-bold">
            {% set duration_seconds = (chamado.fechado_em - chamado.criado_em).total_seconds() %}
            {% if duration_seconds < 3600 %}
              {{ (duration_seconds / 60) | round(0) | int }} minutos
            {% elif duration_seconds < 86400 %}
              {{ (duration_seconds / 3600) | round(1) }} horas
            {% else %}
              {{ (duration_seconds / 86400) | round(1) }} dias
            {% endif %}
          </p>
        </div>
        {% else %}
        <div class="mb-3">
          <label class="form-label text-muted small">Tempo em aberto:</label>
          <p class="text-warning">
            {% set current_time = now() %}
            {% set diff_seconds = (current_time - chamado.criado_em).total_seconds() %}
            {% set diff_hours = (diff_seconds / 3600) | round(1) %}
            
            {% if diff_hours < 24 %}
              {{ diff_hours }} horas
            {% else %}
              {{ (diff_hours / 24) | round(1) }} dias
            {% endif %}
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}