{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Chamados</h4>
  {% if user.has_permission('create_tickets') %}
    <a class="btn btn-success btn-sm" href="{{ url_for('chamados_novo') }}">
      Novo Chamado
    </a>
  {% endif %}
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead><tr>
          <th>ID</th><th>Título</th><th>Status</th><th>Criador</th><th>Atribuído</th><th>Criado em</th><th>Fechado em</th><th></th>
        </tr></thead>
        <tbody>
        {% for c in chamados %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.titulo }}</td>
            <td>{{ c.status }}</td>
            <td>{{ c.creator.username if c.creator else '' }}</td>
            <td>{{ c.assignee.username if c.assignee else '-' }}</td>
            <td>{{ c.created_at.strftime('%d/%m/%Y %H:%M') if c.created_at else '' }}</td>
            <td>{{ c.closed_at.strftime('%d/%m/%Y %H:%M') if c.closed_at else '-' }}</td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('chamados_view', cid=c.id) }}">Ver</a>
              {% if user.has_permission('edit_tickets') %}
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('chamados_editar', cid=c.id) }}">Editar</a>
              {% endif %}
              {% if user.has_permission('close_tickets') and c.status != 'Fechado' %}
                <form action="{{ url_for('chamados_fechar', cid=c.id) }}" method="post" class="d-inline">
                  <input type="hidden" name="resolucao_texto" value="Fechado via lista">
                  <button class="btn btn-sm btn-outline-success">Fechar</button>
                </form>
              {% endif %}
              {% if user.has_permission('delete_tickets') %}
                <form action="{{ url_for('chamados_excluir', cid=c.id) }}" method="post" class="d-inline" onsubmit="return confirm('Excluir chamado {{ c.id }}?');">
                  <button class="btn btn-sm btn-outline-danger">Excluir</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
