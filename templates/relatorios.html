{% extends "base.html" %}
{% block content %}
  <h3>Relatórios</h3>
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form class="row g-2" method="GET">
        <div class="col-md-3">
          <label class="form-label">Data inicial</label>
          <input type="date" class="form-control" name="data_ini" value="{{ data_ini }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data final</label>
          <input type="date" class="form-control" name="data_fim" value="{{ data_fim }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            <option value="">Todos</option>
            {% for s in ['Aberto','Em Andamento','Fechado'] %}
              <option value="{{ s }}" {% if status==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Responsável (fechou)</label>
          <select class="form-select" name="responsavel">
            <option value="">Todos</option>
            {% for op in operadores %}
              <option value="{{ op.id }}" {% if responsavel|int == op.id %}selected{% endif %}>{{ op.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Aberto por</label>
          <select class="form-select" name="aberto_por">
            <option value="">Todos</option>
            {% for us in usuarios %}
              <option value="{{ us.id }}" {% if aberto_por|int == us.id %}selected{% endif %}>{{ us.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Setor</label>
          <select class="form-select" name="setor">
            <option value="">Todos</option>
            {% for s in setores %}
              <option value="{{ s.name if s.name else s.display_name }}" 
                {% if setor == (s.name if s.name else s.display_name) %}selected{% endif %}>{{ s.display_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Urgência</label>
          <select class="form-select" name="urgencia">
            <option value="">Todas</option>
            <option value="Urgente" {% if urgencia == 'Urgente' %}selected{% endif %}>Urgente</option>
            <option value="Não Urgente" {% if urgencia == 'Não Urgente' %}selected{% endif %}>Não Urgente</option>
          </select>
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-primary">Aplicar Filtros</button>
          <a class="btn btn-success" href="{{ url_for('export_xlsx') }}?{{ request.query_string.decode() }}" title="Exportar para Excel">
            <i class="bi bi-file-earmark-excel"></i> Excel
          </a>
          <a class="btn btn-danger" href="{{ url_for('export_pdf') }}?{{ request.query_string.decode() }}" title="Exportar para PDF">
            <i class="bi bi-file-earmark-pdf"></i> PDF
          </a>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Abertas</div>
          <div class="display-6">{{ total_abertas }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Fechadas</div>
          <div class="display-6">{{ total_fechadas }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Média (h)</div>
          <div class="display-6">{{ media_h }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Mediana (h)</div>
          <div class="display-6">{{ mediana_h }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Taxa de fechamento</div>
          <div class="display-6">{{ taxa_fechamento }}%</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted">Total de horas (fechadas)</div>
          <div class="display-6">{{ total_horas }}</div>
        </div>
      </div>
    </div>
  </div>

  {% if chart_files %}
    <div class="chart-grid">
      {% for f in chart_files %}
        <div class="card shadow-sm">
          <img class="card-img-top" src="/{{ f }}" alt="Gráfico">
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">Sem dados para exibir gráficos com os filtros atuais.</div>
  {% endif %}

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>#</th><th>Título</th><th>Status</th><th>Setor</th><th>Abertura</th><th>Fechamento</th><th>Duração(h)</th><th>Aberto por</th><th>Fechado por</th>
            </tr>
          </thead>
          <tbody>
            {% for c in chamados %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.titulo }}</td>
                <td>{{ c.status }}</td><td>{{ c.setor or '—' }}</td>
                <td>{{ c.criado_em.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{% if c.fechado_em %}{{ c.fechado_em.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}</td>
                <td>
                  {% if c.fechado_em %}
                    {{ ((c.fechado_em - c.criado_em).total_seconds() / 3600) | round(2) }}
                  {% else %}-{% endif %}
                </td>
                <td>{{ c.usuario.username if c.usuario else '' }}</td>
                <td>{{ c.fechado_por.username if c.fechado_por else '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}